# 定时任务

## @Scheduled

spring自带注解，用于循环执行任务。使用的话需要添加@EbableScheduling注解

1. 参数

   - cron：

     - 一共七个字符

     ```bash
     * * * * * ? *
     # 分别表示 秒 分 时 天 月 星期几 年
     # 其中年可以省略，星期几用?代替。
     # 星期几 1-7表示周一到周日，还是周末到周六，网上两种说法不一，在使用的时候本机上试一下，可能因为系统不同吧，我的电脑上运行结果是1-7表示周一到周日
     # 如果要隔几秒执行一次，可以用/分开，比如隔2秒执行一次
     @Scheduled(cron="0/2 * * * * ?")
     隔2小时执行一次等举一反三
     ```

     - cron表达式中的通配符含义

     | 符号 | 含义                                                         |
     | ---- | ------------------------------------------------------------ |
     | *    | 所有值,在秒字段上表示每秒执行,在月字段上表示每月执行         |
     | ？   | 不指定值，不需要关心当前指定的字段的值，比如每天都执行但不需要关心周几就可以把周的字段设为? |
     | -    | 区间或者范围,如秒的0-2 ,表示0秒、1秒、2秒都会触发            |
     | ,    | 指定值，比如在0秒、20秒、25秒触发,可以把秒的字段设为0,20,25  |
     | /    | 递增触发,比如秒的字段上设0/3 ,表示从第0秒开始,每隔3秒触发    |
     | L    | 最后，只允许在日字段或周字段上,在日字段上使用L表示当月最后- -天,在周字段上使用3L表示该月最后一个周二 |
     | W    | 只允许用在日字段上,表示距离最近的该日的工作日,工作日指的是周一至周五 |
     | #    | 只允许在周字段上，表示每月的第几个周几，如2#3 , 每月的第3个周二 |

   - fixedDelay

     - 方法执行的间隔时间，从上一次方法执行完成时刻开始计算。下次执行时间=上次执行任务结束时间+时间间隔

   - fixedRate

     - 按照一定的速率执行，从上一次方法执行开始时刻开始计算。下次执行时间=上次执行任务开始时间+时间间隔，注意这里的上次执行任务开始时间只完全适用于第一次任务。fixedRate会自动追平计划时间。

     ```bash
     任务间隔为5s
     假设10:00:00s时，任务第一次执行，任务执行时间较长，执行了7s。
     根据任务的执行计划，10:00:05s时，应该要执行第二次任务，但是此时第一次任务还在执行中，所以第二次执行时间只能等待顺延。
     第一次任务执行结束后(10:00:07)，发现已经晚于第二次执行的计划时间了。会追赶进度，所以第二次任务立即执行。
     这里假设第二次任务只需要执行2s，在10:00:09就执行结束了。计划第三次执行时间为：10:00:10，也就是第二次任务已经追平了，无需继续追赶，此时会遵循计划，在10:00:10时，正常执行第三次任务。
     ```

2. 配置

   默认都是同步执行（按照顺序执行），单线程执行（只能一个一个执行）。

   如果想要多线程，需要配置

   ```yaml
   spring:
   	task:
       scheduling:
         thread-name-prefix: schedule-
         pool:
           size: 5 #线程数
   ```

3. 设置异步执行

   添加@Async注解，并启动@EnableAsync

   ```java
   @Async
   @Scheduled(cron = "0/1 * * * * ?")
   public void testScheduled() throws InterruptedException {
       log.info("方法1");
       Thread.sleep(5000);
   }
   ```

   



> 注意点

看项目需求，同步还是异步，单线程还是多线程。